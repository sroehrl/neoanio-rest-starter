<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LENKRAD Pure-Starter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gaudiamus-css@latest/css/gaudiamus.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.3/axios.min.js"
            integrity="sha512-0qU9M9jfqPw6FKkPafM3gy2CBAvUWnYVOfNPDYKVuRTel1PrciTj+a9P3loJB+j0QmN2Y0JYQmkBBS8W+mbezg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            color: #454545;
        }

        .GET {
            background-color: #1596f8;
            color: white;
        }

        .POST {
            background-color: #29bb3d;
            color: white;
        }

        .PUT, .PATCH {
            background-color: #c0c035;
            color: white;
        }

        .DELETE {
            background-color: #ff0000;
            color: white;
        }

    </style>
    <script>
        const api = axios.create({
            headers: {
                'X-Custom-Header': 'foobar'
            }
        });

        function xData() {
            return {
                data: [],
                token: sessionStorage.token ?? 'run php cli create:jwt --help',
                async init() {
                    const {data} = await axios.get('/api')
                    this.data = data.topics;
                },
                contentType: 'application/json',
                getType(propertyType) {
                    switch (propertyType) {
                        case 'Neoan\\Helper\\FileUpload':
                            return 'file';
                        case 'int':
                        case 'float':
                            return 'number';
                        default:
                            return 'text';
                    }
                },
                async submit(target, route, method) {
                    let payload = {};
                    const re = /:([a-z0-9]+)(\*)*/gi;
                    const paramMatches = [...route.matchAll(re)];

                    Array.from(target.elements).forEach(input => {
                        if (input.name !== '' && input.value !== '') {
                            const hit = paramMatches.find(x => x[1] === input.name);
                            if (hit) {
                                route = route.replace(`:${input.name}` + (hit[2] ?? ''), input.value)
                            } else {
                                if (input.type === 'file') {
                                    this.contentType = 'multipart/form-data';
                                    payload[input.name] = input.files[0];
                                } else {
                                    payload[input.name] = input.value;
                                }
                            }
                        }

                    })
                    route = route.replace(/\/:([a-z0-9]+)(\*)*/gi, '')

                    try {
                        let query = '';
                        if (method === 'GET' && new URLSearchParams(payload).toString() !== '') {
                            query = '?' + new URLSearchParams(payload).toString();
                        }
                        const call = await api.request({
                            method: method,
                            url: route + query,
                            headers: {
                                'Content-Type': this.contentType,
                                'Authorization': 'Bearer ' + this.token.replace(/\n/g, '')
                            },
                            data: payload
                        })
                        this.contentType = 'application/json';
                        target.querySelector('pre').textContent = JSON.stringify(call.data, undefined, 2)
                    } catch (e) {
                        console.error(e)
                        alert(e)
                    }
                }
            }
        }

        const postForm = {
            name: '',
            director: '',
            send() {
                axios.post('/api/movies', {name: this.name, director: this.director}).then(res => {
                    alert('sent');
                    this.name = ''
                    this.director = ''
                })
            }
        }

        function tabs() {
            return {
                tabs:
                    [
                        {title: 'Start', active: true},
                        {title: 'Endpoints', active: false},
                    ]
            }
        }
    </script>
</head>
<body class="bg-gray-light">
<div class="p-5 bg-primary text-white">
    <h1 class="font-lg">LENKRAD API starter project</h1>
</div>
<div x-data="tabs">
    <div class="grid-6-6">
        <template x-for="(tab,i) in tabs">
            <button x-on:click="tabs.forEach((tab,j) => tab.active = j === i)" x-text="tab.title"></button>
        </template>
    </div>
    <template x-if="tabs[0].active">
        <section class="grid m-t-5" x-data="postForm">
            <div class="place-x-center bg-white b-rounded w-80p p-5 raise-1-primary">
                <h2 class="font-md font-strong">Welcome to the fastest & easiest REST-API starter project</h2>
                <p class="font-sm">current controller: {{name}}</p>
                <p>What's included?</p>
                <ul>
                    <li>JWT authentication</li>
                    <li>Attribute routing</li>
                    <li>ORM handler</li>
                    <li>ORM handler</li>
                </ul>
                <p>
                    In order to see the simplicity of handling requests,
                    please have a look at the file <code>src/Example/Api/Example.php</code> <br>
                    The endpoint accepts the methods POST, GET, PUT & DELETE (via attributes)
                </p>
                <h2 class="font-md font-strong">Quick start</h2>
                <h3>Creating new endpoints</h3>
                <ul>
                    <li class="p-y-2">Run
                        <pre class="b-1 b-rounded p-1">php cli create:controller App\Movies\Routes\GetMovies</pre>
                        in your terminal. (On unix systems, you will have to use 2 backslashes)
                    </li>
                    <li class="p-y-2">Add the attribute
                        <pre class="b-1 b-rounded p-1">#[\Neoan\Routing\Attributes\Get('/api/movies')]</pre>
                        to the generated class (src/Movies/GetMovies/GetMovies.php).
                    </li>
                    <li class="p-y-2">Visit <a class="text-primary" href="/api/movies" target="_blank">/api/movies</a>
                    </li>
                    <li class="p-y-2">Let's create a POST-endpoint as well
                        <pre class="b-1 b-rounded p-1">php cli create:controller App\Movies\Routes\CreateMovie</pre>
                    </li>
                    <li class="p-y-2">And route it via
                        <pre class="b-1 b-rounded p-1">#[\Neoan\Routing\Attributes\Post('/api/movies')]</pre>
                    </li>
                </ul>
                <h3>Creating a new model</h3>
                <ul>
                    <li class="p-y-2">Run
                        <pre class="b-1 b-rounded p-1">php cli create:model App\Movies\MovieModel</pre>
                        in your terminal. (On unix systems, you will have to use 2 backslashes)
                    </li>
                    <li class="p-y-2">
                        Open the file <code>src/Movies/MovieModel.php</code> and add two properties:
                        <ul style="list-style: none">
                            <li class="p-y-2">public string $name;</li>
                            <li class="p-y-2">public string $director;</li>
                        </ul>
                    </li>
                    <li class="p-y-2">
                        Then, migrate all models
                        <pre class="b-1 b-rounded p-1">php cli migrate:models sqlite</pre>
                    </li>
                </ul>
                <h3>Connecting the dots</h3>
                <ul>
                    <li class="p-y-2">
                        Let's revisit our <code>CreateMovie</code>-controller and apply the following changes:
                        <pre class="b-1 b-rounded p-1"><span style="text-decoration: line-through;">return ['name' => 'CreateMovie'];</span></pre>
                    </li>
                    <li class="p-y-2">
                        <pre class="b-1 b-rounded p-1">$newMovie = MovieModel::retrieveOneOrCreate(\Neoan\Request\Request::getInputs())->store();</pre>
                    </li>
                    <li class="p-y-2">
                        <pre class="b-1 b-rounded p-1">return $newMovie->toArray();</pre>
                    </li>
                    <li class="p-y-2">Now let's create one or two movies
                        <form action="/api/movies" method="post" x-on:submit.prevent="send">
                            <input x-model="name" name="name" class="b-rounded b-1 b-primary p-x-2" placeholder="Name">
                            <input x-model="director" name="director" class="b-rounded b-1 b-primary p-x-2"
                                   placeholder="Director">
                            <button type="submit" class="b-rounded bg-primary text-white b-white cursor-pointer">store
                            </button>
                        </form>
                    </li>
                    <li class="p-y-2">
                        Finally, we can expose our movies through our <code>GetMovies</code>-controller
                        <pre class="b-1 b-rounded p-1"><span style="text-decoration: line-through;">return ['name' => 'GetMovies'];</span></pre>
                    </li>
                    <li class="p-y-2">
                        <pre class="b-1 b-rounded p-1">return MovieModel::retrieve()->toArray();</pre>
                    </li>
                    <li class="p-y-2">That's it! Let's try it: <a class="text-primary" href="/api/movies"
                                                                  target="_blank">/api/movies</a></li>
                </ul>
                <h3>Ready for the deep-dive?</h3>
                <p>
                    This starter is based on <a class="text-primary"
                                                href="https://github.com/sroehrl/neoan.io-lenkrad-core#readme">neoan.io
                    LENKRAD</a>.
                    You can use this code under MIT license in any project of your choice.
                </p>
            </div>
        </section>
    </template>
    <template x-if="tabs[1].active">
        <section x-data="xData" x-init="$watch('token', value => sessionStorage.token = value); init()">
            <div class="container p-5">
                <div class="grid grid-4-6-2 m-x-5">
                    <h2>Auth-token</h2>
                    <textarea class="place-y-center b-rounded b-primary" x-model="token"></textarea>
                </div>

            </div>
            <div class="container" >
                <template x-for="(methods,topic) in data">
                    <div class="w-80p bg-white b-rounded w-80p p-5 m-b-3">
                        <h2 x-text="topic">{{topic}}</h2>
                        <template x-for="method in methods">
                            <div >
                                <div class="grid-2-8-2">
                                    <h3 x-bind:class="method.method" class="p-x-2 m-r-5" x-text="method.method">{{method.method}}</h3>
                                    <h3 x-text="method.route">{{method.route}}</h3>
                                    <div class="p-y-2 cursor-pointer" x-on:click="method.expanded =! method.expanded">
                                        <svg style="height: 24px" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path>
                                        </svg>
                                    </div>
                                </div>
                                <form x-on:submit.prevent="submit($event.target, method.route, method.method)" x-show="method.expanded" x-transition>
                                    <button type="button" class="b-rounded b-1" x-on:click="method.try =!method.try">TOGGLE TRY</button>
                                    <template x-for="property in method.properties">

                                        <div class="grid-4-6-2">
                                            <p x-bind:class="property.required ? 'font-strong' : 'text-gray'" x-text="property.property"></p>
                                            <div>
                                                <p x-text="property.type"></p>
                                                <input x-show="method.try" x-bind:name="property.property" x-bind:type="getType(property.type)">
                                            </div>

                                            <p class="place-x-end">
                                                <span x-show="property.required">required</span>
                                                <span x-show="!property.required">optional</span>
                                            </p>
                                        </div>
                                    </template>
                                    <div class="grid">
                                        <button x-show="method.try" type="submit" class="b-1 b-primary text-primary bg-transparent b-rounded-3 hover:bg-primary hover:text-white hover:raise-1-gray cursor-pointer place-x-end font-md p-x-3">send</button>
                                    </div>
                                    <div >

                                        <pre style="overflow-x: auto; max-width: 100%" class="text-white bg-black p-3" x-text="'returns: ' + method.returns">results</pre>
                                    </div>
                                </form>
                            </div>
                        </template>

                    </div>
                </template>
            </div>
        </section>
    </template>
</div>


</body>
</html>